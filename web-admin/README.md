# Ayia Administration

Ayia makes use of a number of Biblical sources:
- YouVersion
- [Berean Standard Bible (interlinear)](versions/interlinear/bsb)
- [NIV-1984](versions/pdf/niv84)
- Strongs : source [openscriptures/strongs](https://github.com/openscriptures/strongs);

These all need to be fetched, extracted, prepared and loaded into the Ayia
database.


Before proceeding, make sure you have initialized the project:
```
npm install
```


## Viewing sources

You can view/identify all available sources via:
```
./etc/version-list

# Lists all available versions/sources presenting:
#   Offical Abbreviation : Local Abbreviation : Full Name
```

You can also view more details about a specific source via:
```
./etc/version-find %Abbreviation%

```

## Loading sources

The loading process involves 4 steps:
1.  Fetch   : download the source data;
    ```
    ./etc/version-fetch %Abbreviation%
    ```
2.  Extract : extract the source data into a processable form;
    ```
    ./etc/version-extract %Abbreviation%
    ```
3.  Prepare : prepare the extracted data for loading;
    ```
    ./etc/version-prepare %Abbreviation%
    ```
4.  Load    : load the prepared data into the database;
    ```
    ./etc/version-load %Abbreviation%
    ```

Each step will automatically invoke the previous if the data required for a
step is not yet available.

Note that the final `Load` process requires direct access to the Ayia database.

From within a container in the Ayia k8s cluster, this should already be setup.

From an external system, this requires additional work:
1.  Request `kubectl` configuration for the Ayia k8s cluster along with
    database access credentials (username, password, database name);
2.  Install `kubectl`;
3.  Setup your `kubectl` configuration to include the Ayia k8s cluster
    credentials;
4.  Update the `CTX` varialbe in [Makefile](Makefile) with the kubectl context
    you established in your local `kubectl` configuration;
5.  Create a proxy from the external system to the Ayia k8s cluster. With a
    functional `kubectl` configuration file and proper updates to `CTX`, you
    should be able to use the [etc/mongo-proxy.sh](etc/mongo-proxy.sh) helper
    script for this;
6.  Update [etc/config.yaml](etc/config.yaml) with the Ayia database access
    credentials;

## Database schemas

Ayia makes use of mongodb with a single database containing multiple
collections:
- `versions` (`version` is a mongo system keyword) : contains a document for
  each Bible version loaded into the database;
  - For each loaded Bible version, there will be a collection named using the
    `abbreviation` from the `versions` document describing this version;
- `concordance` : contains a document for each Concordance (e.g. Strongs)
  loaded into the database;
- `commentary` : contains a document for each Commentary loaded into the
  database;

### Versions

Documents within the `versions` collection have the form the consists of
*at least* :
```javascript
{
  _id         : Id generated by mongo {ObjectId};
  id          : A unique id for this version {Number};
  abbreviation: The unique, upper-cased abbreviation for this version {String};
  title       : The title for this version {String};
  type        : The format type (yvers, interlinear, pdf) {String};
  language    : {
    iso_639_1             : ISO 639-1 2-character language code {String};
    iso_639_3             : ISO 639-3 3-character language code {String};
    name                  : The human readable language name {String};
    language_tag          : The primary (ISO 639-1) language tag for this
                            version {String};
    secondarylanguage_tags: A set of secondary language tags (ISO 639-1) for
                            this version {String};
  },

}
```

Each version will have a collection named using the `abbreviation` from the
version list and will have the form:
```javascript
{
  _id   : The BOK.ccc.vvv reference (e.g. GEN.001.001) {String};
  markup: [
    // markup items specific to the `version.type` for this verse
    ...
  ],
  text  : The full text of this verse {String};
}
```

#### Type `yvers` and `pdf` markup
Versions with a type of `yvers` (and `pdf` which uses the same format) will
have markup based on [USX](https://ubsicap.github.io/usx/index.html) /
[USFM](https://ubsicap.github.io/usfm/).

Verse entries will be of the form:
```yaml
{
  GEN.001.001: {
    markup: [
      { %type%: {String | Array} },
      ...
    ],
    text: {String},
  },
  ...
}
```

For these entries, the `%type%` will begin with either `#` (new item) or `+`
(continued item).

When a `%type%` value is an Array, it often begins with a label followed by a
set of strings that define the content, for example:
```yaml
{
  GEN.001.001: {
    markup: [
      { #s1: "The Beginning" },
      { #pi: [
          { label: "1" },
          "In the beginning God created the heavens and the earth."
        ]
      }
    ],
    "text": "In the beginning God created the heavens and the earth."
  }
}
```

Following [USX](https://ubsicap.github.io/usx/index.html) /
[USFM](https://ubsicap.github.io/usfm/), the base `%type%` will be strings
like:
- [p](https://ubsicap.github.io/usx/parastyles.html#p) : normal paragraph;
- [pi#](https://ubsicap.github.io/usx/parastyles.html#pi) : indented
  paragraph;
- [s#](https://ubsicap.github.io/usx/parastyles.html#s) : section header;
- [note.f](https://ubsicap.github.io/usx/notes.html#footnote-note) :
  footnote;
- [note.x](https://ubsicap.github.io/usx/notes.html#cross-reference-note) :
  cross-reference;

In addition, we:
- add `label` to explicitly identify a verse or note label;
- perform additional processing on `note.x` and `note.f` elements, parsing any
  simple text of references and augmenting the node with `refs` containing
  normalized verse references. For example:
  - A `note.x` with text `See Matt. 25:1` is augmented with `refs` for a final
    `note.x` object of the form:
    ```yaml
    { note.x: [
        { label: '#' },
        { xt: { text: 'See Matt. 25:1', ref: 'MAT.025.001' } },
      ]
    }
    ```
  - `Judg. 14:20; Song 5:1`:
    ```yaml
        { xt: { text: 'Judg. 14:20', ref: 'JDG.014.020' } },
        '; ',
        { xt: { text: 'Song 5:1', ref: 'SNG.005.001' } },
    ```
  - `[ver. 19; ch. 1:11; 5:43; 12:37]` (from John 3:32):
    ```yaml
        { xt: { text: '[ver. 19', ref: 'JHN.003.019' } },
        ', ',
        { xt: { text: 'ch. 1:11', ref: 'JHN.001.011' } },
        ', ',
        { xt: { text: '5:43', ref: 'JHN.005.043' } },
        ', ',
        { xt: { text: '12:37]', ref: 'JHN.012.037' } },
    ```
  - `[ch. 6:27; 2 Cor. 1:22; Eph. 1:13; Rev. 7:3-8]` (from John 3:33):
    ```yaml
        { xt: { text: '[ch. 6:27', ref: 'JHN.006.027' } },
        '; ',
        { xt: { text: '2 Cor. 1:22', ref: '2CO.001.022' } },
        '; ',
        { xt: { text: 'Eph. 1:13', ref: 'EPH.001.013' } },
        '; ',
        { xt: { text: 'Rev. 7:3-8]', ref: 'REV.007.003-008' } },
    ```
  - `[Ezek. 4:11, 16]`:
    ```yaml
        { xt: { text: '[Ezek. 4:11', ref: 'EZK.004.011' } },
        ', ',
        { xt: { text: '16]', ref: 'EZK.004.016' } },
    ```


#### Type `interlinear` markup
Versions with a type of `interlinear` will have markup items in the following
form:
```javascript
{
  language  : The language of this entry (Hebrew | Greek) {String};
  abs_vs    : The absolute verse number {Number};
  wlc       : Text from the Westminster Leningrad Codex {String};
  translit  : Text from the Westminster Leningrad Codex {String};
  tos       : Identifies the type-of-speech {String};
  tos_label : A descriptive label for `tos` {String};
  strongs   : The strongs reference, in relation to `language` {Number};
  heading   : Any section heading related to this entry {String};
  xref      : Any cross reference to other verses
              (e.g. '(John 1:1-5; Hebrews 11:1-3)') {String};
  text      : The text of this entry {String};
  footnotes : Footnote text related to this entry {String};
  bdb       : BDB / Thayers notes {String};
}
```

### Concordance
### Commentary
